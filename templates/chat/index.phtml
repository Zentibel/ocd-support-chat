<style>
form#compose {
    position: fixed;
    bottom: 0px;
    width: 100%;
    border-top: 1px solid #DDD;
}

textarea#compose-message {
    box-sizing: border-box;
    width: 100%;
    min-height: 40px;
    max-height: 180px;
    resize: none;
    padding: 5px;
    padding-right: 70px;

    border: none;
    outline: none;
}

button#send-button {
    position: fixed;
    cursor: pointer;
    right: 0px;
    bottom: 0px;
    background: none;
    border: none;
    border-left: 1px solid #DDD;
    width: 70px;
    height: 50px;
    outline: none;
}

span.rounded > img.avatar {
    display: inline;
    height: 100%;
    width: auto;
    min-width: 100%;
    margin: 0 auto;
}

section#content {
    overflow-y: scroll;
    margin-bottom: 50px;
}
span.timestamp {
    color: #DDD;
    float: right;
}

span.rounded {
    vertical-align: middle;
    display: inline-block;
    position: relative;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    margin: 0 auto;
    overflow: hidden;
}
div#chat-log img {
    max-width: 95%;
}
span.sender {
    margin-left: 10px;
    font-weight: bold;
    position: relative;
    top: 2px;
}

span.sender.source-gliph:after {
    content: ' (via gliph)';
    color: #DDD;
    font-weight: normal;
}

div.message {
    margin-left: 50px;
}

</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/autosize.js/3.0.20/autosize.min.js"></script>

<div id="chat-log">

</div>

<form id="compose">
    <textarea id="compose-message" placeholder="Don't be shy, type a message!" autocomplete="off"></textarea>

    <button id="send-button">Send &raquo;</button>

</form>

<script>
var ROOM_ID = 'dd0c62bd-c4f2-4286-affa-256bfcc93955';

<? if ($this->routeParam('community') == 'ocdmods'): ?>
var ROOM_ID = 'e6ddc009-a7c0-4bf9-8637-8a3da4d65825';
<? endif; ?>

var latestMessageTimestamp = 0;
var receivedMessageKeys = {};

function getLatestMessages(id) {
    $.getJSON('/messages/' + id, function(messages) {
        for (i=0; i<messages.length; i++) {
            message = messages[i];
            if (receivedMessageKeys[message.key]
             || message.timestamp < latestMessageTimestamp
             || message.senderName == 'ocdbot'
            ) {
                continue;
            }
            latestMessageTimestamp = message.timestamp;
            receivedMessageKeys[message.key] = true;

            mTimestamp = moment.unix(message.timestamp);
            timeDisplay = mTimestamp.fromNow();
            timeDisplayAlt = mTimestamp.format('YYYY-MM-DD HH:mm:ss')

            $('#chat-log').append('');
            $('#chat-log').append(
                '<span class="rounded"><img class="avatar" src="' + message.senderAvatar + '"></span>' +
                '<span class="timestamp" data-timestamp="'+message.timestamp+'" title="'+timeDisplayAlt+'">' + timeDisplay + '</span>' +
                '<span class="sender source-'+ message.source +'">' + message.senderName + ':</span> ' +
               '<div class="message">'+ markdown.toHTML(message.message) + '</div>'
            );
            if (message.media) {
                for (j=0; j<message.media.length; j++) {
                    $('#chat-log').append('<div class="message"><img src="' + message.media[j].thumbnail + '"></div>');
                }
            }
            //$('#chat-log').append('</div>');

        }
        setTimeout(function(){ updateScroll('content'); }, 100);
    });
};

setInterval(function(){
    $('span.timestamp').each(function() {
        mTimestamp = moment.unix($(this).data('timestamp'));
        $(this).text(mTimestamp.fromNow());
    });
}, 60000);

function updateScroll(el) {
    var element = document.getElementById(el);
    element.scrollTop = element.scrollHeight;
}
updateScroll('content');

EventBus.addEventListener('window:resize:height', function() {
    updateScroll('content');
});

$(document).ready(function() {

    $('#compose-message').each(function(){
        autosize(this);
    }).on('autosize:resized', function(){
        $('section#content').css('margin-bottom', $(this).height() + 12 + 'px');
        $('button#send-button').height($(this).height() + 12);
        updateScroll('content');
    });

    getLatestMessages(ROOM_ID);

    $('form#compose').submit(function(event) {
     event.preventDefault();
     if (!$('#compose-message').val().trim()) {
         return;
     }

     $('#compose-message').attr('disabled','disabled');
     $('button#send-button').html('Sending');
     $.post('/messages/' + ROOM_ID, { message: $('#compose-message').val() }, function(result) {
         $('#compose-message').removeAttr('disabled');
         $('#compose-message').val('');
         $('button#send-button').html('Send &raquo;');
         autosize.update($('#compose-message'));
         $('#compose-message').focus();
     });
    });

});


var shiftDown = false;
var chatForm = $("#compose");
var messageBox = chatForm.children("textarea");

$(document).keypress(function (e) {
    if(e.keyCode == 13) {
        if(messageBox.is(":focus") && !shiftDown) {
            e.preventDefault(); // prevent another \n from being entered
            chatForm.submit();
        }
    }
});

$(document).keydown(function (e) {
    if(e.keyCode == 16) shiftDown = true;
});

$(document).keyup(function (e) {
    if(e.keyCode == 16) shiftDown = false;
});

</script>
